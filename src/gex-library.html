<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/mixins/gesture-event-listeners.html">

<!-- app elements -->
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">

<!-- iron elements -->
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">

<!-- paper elements -->
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">

<!-- vaadin elements -->

<link rel="import" href="../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-selection-column.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-filter.html">

<link rel="import" href="./gex-icons.html">

<link rel="import" href="../bower_components/chips-api/chips-api.html">
<link rel="import" href="../bower_components/chips-api/behaviors/chips-plugin-behavior.html">

<!-- <dom-module id="valo-grid" theme-for="vaadin-grid">
  <template>
    <style include="valo-grid">
      [part~="header-cell"],
      [part~="footer-cell"] {
        background-color: blue;
      }
    </style>
  </template>
</dom-module> -->

<dom-module id="gex-library">
  <template>
    <style>
      :host {
        display: flex;
        height: 100%;
        flex-direction: column;
      }

      .container {
        flex: 1;
        display: flex;
      }

      .left-panel {
        width: 172px;
        background-color: red;
      }

      .main-panel {
        flex: 1;
        flex-direction: column;
        display: flex;
      }

      .query-selection {
        height: 72px;
        flex-shrink: 0;
        background-color: blue;
      }

      .overlay {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-primary-color);
        font-weight: lighter;
      }

      .overlay > * {
        text-align: center;
      }

      .query-results {
        flex: 1;
        background-color: var(--default-primary-color);
        position: relative;
        display: flex;
        flex-direction: column;
      }

      paper-button {
        font-size: 12px;
        /* background-color: var(--paper-green-500); */
        color: grey;
        border: 1px solid grey;
      }

      paper-button[active], paper-button.search {
        background-color: var(--accent-color);
        border-color: var(--accent-color);
        color: white;
      }

      paper-button[disabled] {
        background-color: var(--default-primary-color);
        border-color: var(--default-primary-color);
        color: var(--disabled-text-color);
      }

      paper-button.settings {
        border: none;
      }

      paper-icon-button {
        color: #fff;
      }

      paper-input {
        display: inline-block;
      }

      paper-input paper-icon-button {
        width: 23px;
        height: 23px;
        padding: 0px 4px;
      }

      paper-input label {
        color: grey;
      }

      vaadin-grid {
        background-color: var(--dark-primary-color);
        height: 100%;
      }
      
      .section {
        display: flex;
        align-items: center;
        height: 80%;
        padding-left: 6px;
        padding-right: 6px;
      }

      .section.search {
        flex: 1;
      }

      .section.search paper-input {
        flex:1;
      }

      .section.parameters {
        max-width: 368px;
      }

      .section .title {
        font-size: 14px;
        font-weight: lighter;
        height: 100%;
        color: var(--secondary-text-color);
      }

      .section .values {
        display:flex;
        flex-wrap: wrap;
        align-items: center;
        height: 100%;
      }

      .border-left {
        border-left: 1px solid var(--divider-color);
      }

      [hidden] {
        display: none;
      }
    </style>

    <chips-api
      id="API"></chips-api>

    <app-toolbar>
      <div class="section">
        <paper-dropdown-menu label="Data source">
          <paper-listbox slot="dropdown-content" selected="0">
            <paper-item>Remote PACS Server</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>
        <paper-button class="settings" on-tap="openPacsSettingsDialog"><iron-icon icon="icons:settings"></iron-icon>Settings</paper-button>
      </div>
      <div class="section border-left">
        <paper-dropdown-menu label="Search by">
            <paper-listbox slot="dropdown-content" selected="0">
              <paper-item>Patient ID</paper-item>
              <paper-item>Patient Name</paper-item>
              <paper-item>Study Desc.</paper-item>
              <paper-item>Series Desc.</paper-item>
            </paper-listbox>
          </paper-dropdown-menu>
      </div>
      <div class="search section border-left">
        <paper-input label="Search input" value="{{searchInput}}">
          <paper-icon-button hidden$=[[noValue(searchInput)]] on-tap="clearSearchInput" slot="suffix" icon="clear" alt="clear" title="clear">
          </paper-icon-button>
        </paper-input>
        <paper-button class="search" on-tap="search" disabled$=[[noValue(searchInput)]]><iron-icon icon="icons:search"></iron-icon>Search data</paper-button>
      </div>
    </app-toolbar>

    <div class="container">
      <div class="left-panel">
        ADVANCED RESULTS FILTERING
        <paper-button on-tap="addData">Add data</paper-button>
        <paper-button on-tap="statusReady">Ready</paper-button>
        <paper-button on-tap="statusProgress">Progress</paper-button>
        <paper-button on-tap="statusError">Error</paper-button>
      </div>
      <div class="main-panel">
          <div class="query-results">
            <div
              hidden$="[[!isProgress]]"
              class="search overlay">
              <div>
                <paper-spinner active>...</paper-spinner>
                <template is="dom-repeat" items="[[loadingSteps]]">
                  <div>[[index]] - [[item]]</div>
                </template>
              </div>
            </div>
            <div
              hidden$="[[!isError]]"
              class="error overlay">
              <div>
                <div>[[errorMessage]]</div>
                <div>Please make sure the data source settings are correct and try again.</div>
                <div>If the error persists, contact dev@babymry.org for assistance.</div>
              </div>
            </div>
            <vaadin-grid
              hidden$="[[!isReady]]"
              id="grid"
              aria-label="Basic Binding Example"
              multi-sort="true"
              items="[[data]]"
              selected-items="{{selection}}"      
              active-item="{{activeItem}}">
            <!-- <vaadin-grid-selection-column id="selectionColumn" auto-select>
            </vaadin-grid-selection-column> -->
      
            <vaadin-grid-column>
              <template class="header">
                <vaadin-grid-sorter path="PatientName.value">
                  <vaadin-grid-filter aria-label="Patient Name" path="PatientName.value" value="[[_filterPatientName]]">
                    <paper-input slot="filter" label="Patient Name" value="{{_filterPatientName::input}}"></paper-input>
                  </vaadin-grid-filter>
                </vaadin-grid-sorter>
              </template>
              <template>[[item.PatientName.value]]</template>
            </vaadin-grid-column>
      
            <vaadin-grid-column>
              <template class="header">
                <vaadin-grid-sorter path="PatientID.value">
                  <vaadin-grid-filter aria-label="Patient ID" path="PatientID.value" value="[[_filterPatientID]]">
                    <paper-input slot="filter" label="Patient ID" value="{{_filterPatientID::input}}"></paper-input>
                  </vaadin-grid-filter>
                </vaadin-grid-sorter>
              </template>
              <template>[[item.PatientID.value]]</template>
            </vaadin-grid-column>
      
            <vaadin-grid-column>
              <template class="header">
                <vaadin-grid-sorter path="StudyDescription.value">
                  <vaadin-grid-filter aria-label="Study Description" path="StudyDescription.value" value="[[_filterStudyDescription]]">
                    <paper-input slot="filter" label="Study Description" value="{{_filterStudyDescription::input}}"></paper-input>
                  </vaadin-grid-filter>
                </vaadin-grid-sorter>
              </template>
              <template>[[item.StudyDescription.value]]</template>
            </vaadin-grid-column>
      
            <vaadin-grid-column>
              <template class="header">
                <vaadin-grid-sorter path="SeriesDescription.value">
                  <vaadin-grid-filter aria-label="Series Description" path="SeriesDescription.value" value="[[_filterSeriesDescription]]">
                    <paper-input slot="filter" label="Series Description" value="{{_filterSeriesDescription::input}}"></paper-input>
                  </vaadin-grid-filter>
                </vaadin-grid-sorter>
              </template>
              <template>[[item.SeriesDescription.value]]</template>
            </vaadin-grid-column>
      
            <vaadin-grid-column>
              <template class="header">
                <vaadin-grid-sorter path="ModalitiesInStudy.value">
                  <vaadin-grid-filter aria-label="Modalities in Study" path="ModalitiesInStudy.value" value="[[_filterModalitiesInStudy]]">
                    <paper-input slot="filter" label="Modalities in Study" value="{{_filterModalitiesInStudy::input}}"></paper-input>
                  </vaadin-grid-filter>
                </vaadin-grid-sorter>
              </template>
              <template>[[item.ModalitiesInStudy.value]]</template>
            </vaadin-grid-column>
      
          </vaadin-grid>
          </div>
          <div id="selectionCheckout" hidden="[[isSelectionEmpty]]" class="query-selection">
            <paper-button on-tap="retrieveData">View selection [[selection.0.PatientID.value]]</paper-button>
          </div>
      </div>
    </div>

  </template>

  <script>
    class GexLibrary extends
      CHIPSPluginBehavior(
        Polymer.GestureEventListeners(
          Polymer.Element)) {
      static get is() {
        return 'gex-library';
      }

      static get properties() {
        return {
          aet: {
            type: String,
          },
          aec: {
            type: String,
          },
          aetListener: {
            type: String,
          },
          feedLink: {
            type: String,
          },
          moveLink: {
            type: String,
          },
          moveInstance: {
            type: String,
          },
          queryLink: {
            type: String,
          },
          queryInstance: {
            type: String,
          },
          serverIp: {
            type: String,
          },
          serverPort: {
            type: String,
          },
          searchInput: {
            type: String,
            value: '',
          },
          data: {
            type: Array,
            value: [],
          },
          loadingSteps: {
            type: Array,
            value: [],
          },
          errorMessage: {
            type: String,
            value: '',
          },
          activeItem: {
            type: Object,
            value: null,
            observer: '_activeItemChanged',
          },
          selection: {
            type: Array,
            value: [],
            notify: true,
          },
          isSelectionEmpty: {
            type: Boolean,
            value: true,
          },
          isReady: {
            type: Boolean,
            value: true,
            observer: '_isReadyChanged',
          },
          isError: {
            type: Boolean,
            value: false,
            observer: '_isErrorChanged',
          },
          isProgress: {
            type: Boolean,
            value: false,
            observer: '_isProgressChanged',
          },
        };
      }

      static get observers() {
        return [
            '_selectionChanged(selection.splices)',
          ];
      }

      openPacsSettingsDialog() {
        const openPacsSettingsDialogEvent =
          new CustomEvent('open-pacs-settings-dialog', {});
        this.dispatchEvent(openPacsSettingsDialogEvent);
      }

      noValue(value) {
        return value === '';
      }

      clearSearchInput() {
        this.searchInput = '';
      }

      isSelectionEmpty(selection) {
        console.log(selection);
        return selection.length === 0;
      }

      _selectionChanged() {
        this.isSelectionEmpty = (this.selection.length <= 0);
      }

      _activeItemChanged(item) {
        this.selection = item ? [item] : [];
      }

      addData() {
        const data = {
          PatientName: {
            value: 'Nicolas',
          },
          PatientID: {
            value: Date.now(),
          },
          SeriesDescription: {
            value: '270387',
          },
          StudyDescription: {
            value: '270387',
          },
          ModalitiesInStudy: {
            value: 'MR',
          },
        };

        this.push('data', data);
      }

      search() {
        // prepare data
        const data = {};
        data.auth = {
          type: 'token',
          token: sessionStorage.getItem('token'),
        };
        //
        data.body = {};
        data.body.template = {};
        data.body.template.data = [
          {name: 'aet', value: ''},
          {name: 'aec', value: ''},
          {name: 'server_ip', value: ''},
          {name: 'server_port', value: ''},
        ];

        data.body.data = {};
        data.body.data['aet'] = this.aet;
        data.body.data['aet_listener'] = this.aetListener;
        data.body.data['aec'] = this.aec;
        data.body.data['server_ip'] = this.serverIp;
        data.body.data['server_port'] = this.serverPort;

        const patientID = this.searchInput;
        data.body.template.data.push({
          name: 'patient_id',
          value: '',
        });
        data.body.data['patient_id'] = patientID;

        // post to CUBE
        this.isProgress = true;
        this.loadingSteps = [];
        this.loadingSteps.push('Starting PACS Query...');
        const start = this.__startPlugin(this.$.API, this.queryLink, data);
        start.then((response) => {
            console.log(response);
            this.queryInstance = Number(response.data[0].data.id);
            this.feedLink = response.data[0].links.feed;
            this.push('loadingSteps', 'Contacting the PACS Server...');
            return response;
          })
          // https://github.com/FNNDSC/ChRIS_ultron_backEnd/issues/17
          .then(this.__wait.bind(this, 1000))
          .then((response) => {
            this.push('loadingSteps', 'Waiting for answer...');
            return response;
          })
          .then(this.__waitEndPlugin.bind(this, this.$.API, data))
          .then((response) => {
            this.push('loadingSteps', 'Processing results...');
            return response;
          })
          .then(this.__getFilesPlugin.bind(this, this.$.API, data))
          .then(this._getFileContent.bind(this))
          .then(this._handleQueryResponse.bind(this))
          .catch(this._handleQueryError.bind(this));
      }

      _getFileContent(files) {
        const file = files[0].links.file_resource;
        const data = {};
        data.auth = {
          type: 'token',
          token: sessionStorage.getItem('token'),
        };
        return this.$.API.request('GET', file, data);
      }

      _handleQueryResponse(response) {
        this.isReady = true;
        // set data
        // this.data = response; ?
      }

      _handleQueryError(error) {
        this.isError = true;
        this.errorMessage = error.notification.text;
        console.log(error);
      }

      retrieveData() {
        const data = {};
        data.auth = {
          type: 'token',
          token: sessionStorage.getItem('token'),
        };
        //
        data.body = {};
        data.body.template = {};
        data.body.template.data = [
          {name: 'aet', value: ''},
          {name: 'aec', value: ''},
          {name: 'server_ip', value: ''},
          {name: 'server_port', value: ''},
          {name: 'previous_id', value: ''},
        ];

        data.body.data = {};
        data.body.data['aet'] = this.aet;
        data.body.data['aet_listener'] = this.aetListener;
        data.body.data['aec'] = this.aec;
        data.body.data['server_ip'] = this.serverIp;
        data.body.data['server_port'] = this.serverPort;
        data.body.data['previous_id'] = this.queryInstance;

        const uids = [];
        for (let j=0; j<this.selection.length; j++) {
          uids.push(this.selection[j]['uid'].value);
        }
        if (uids.length > 0) {
          data.body.template.data.push(
            {name: 'series_uids', value: ''});
          data.body.data['series_uids'] = uids.join(',');
        }

        const start = this.__startPlugin(this.$.API, this.moveLink, data);
        start.then(this._handleRetrieveResponse.bind(this))
          .catch(this._handleRetrieveError.bind(this));

        // also get the atlases
      }

      _handleRetrieveResponse(response) {
        this.set('moveInstance', response.data[0]);
        // go to the viewer
        const moveStarted = new CustomEvent(
          'start-move',
          {
            detail: {
              feedLink: this.feedLink,
              pluginInstance: this.moveInstance,
          },
        });

        // booo :(
        // backend hangs if we do not wait a bit....
        window.setTimeout(
          () => {
            this.dispatchEvent(moveStarted);
          }, 1000);
      }

      _handleRetrieveError(error) {
        console.log('retrieve error');
        console.log(error);
      }

      statusReady() {
        this.isReady = true;
      }

      statusError() {
        this.isError = true;
      }

      statusProgress() {
        this.isProgress = true;
      }

      _isReadyChanged(isReady) {
        if (isReady) {
          this.isError = false;
          this.isProgress = false;
          this.selection = [];
          this.loadingSteps = [];
        }
      }

      _isErrorChanged(isError) {
        if (isError) {
          this.isReady = false;
          this.isProgress = false;
          this.selection = [];
          this.loadingSteps = [];
        }
      }

      _isProgressChanged(isProgress) {
        if (isProgress) {
          this.isReady = false;
          this.isError = false;
          this.selection = [];
          this.loadingSteps = [];
        }
      }

      validatePatientID() {
        // only letters, return and comma are valid characters
        const re = /[^a-zA-Z0-9\n\,\ ]/;
        const foundInvalid = this.patientID.match(re);

        if (foundInvalid && foundInvalid.length > 0) {
          this.$.patientIDInput.errorMessage =
            'Some of the characters are not valid.';
          this.$.patientIDInput.invalid = true;
          return false;
        }

        return true;
      }

      formatPatientID() {
        // replace line break and spaces by commas
        const re = /[\n\ ]/gi;
        const formattedPatientID = this.patientID
          .trim()
          .replace(re, ',');
        return formattedPatientID;
      }
    }

    window.customElements.define(GexLibrary.is, GexLibrary);
  </script>
</dom-module>
