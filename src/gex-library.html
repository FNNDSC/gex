<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/mixins/gesture-event-listeners.html">

<!-- app elements -->
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">

<!-- iron elements -->
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">

<!-- paper elements -->
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">

<!-- vaadin elements -->
<link rel="import" href="../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-selection-column.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-filter.html">

<link rel="import" href="./gex-icons.html">

<!-- <dom-module id="vaadin-grid-styles" theme-for="vaadin-grid">
  <template>
    <style>
      /* Old way */

        [part~="header-cell"] {
          background-color: var(--default-primary-color);
          padding-top: 0;
    padding-bottom: 0;
        };
        [part~="body-cell"] {
          background-color: var(--dark-primary-color);
        };
        [part~="row"]:hover {
          background-color: var(--light-primary-color);
          font-weight: bold;
          cursor: pointer;
        };
        --vaadin-grid-body-row-selected-cell {
          background-color: var(--light-primary-color);
        };
    </style>
  </template>
</dom-module> -->

<dom-module id="gex-library">
  <template>
    <style>
      :host {
        display: flex;
        height: 100%;
        flex-direction: column;
      }

      .container {
        flex: 1;
        display: flex;
      }

      .left-panel {
        width: 172px;
        background-color: red;
      }

      .main-panel {
        flex: 1;
        flex-direction: column;
        display: flex;
      }

      .query-selection {
        height: 92px;
        flex-shrink: 0;
        background-color: blue;
      }

      .overlay {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
      }

      .query-results {
        flex: 1;
        background-color: #59E959;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      paper-button {
        font-size: 12px;
        /* background-color: var(--paper-green-500); */
        color: grey;
        border: 1px solid grey;
      }

      paper-button[active], paper-button.search {
        background-color: var(--accent-color);
        border-color: var(--accent-color);
        color: white;
      }

      paper-button.settings {
        border: none;
      }

      paper-icon-button {
        color: #fff;
      }

      paper-input {
        display: inline-block;
      }

      paper-input paper-icon-button {
        width: 23px;
        height: 23px;
        padding: 0px 4px;
      }

      paper-input label {
        color: grey;
      }

      vaadin-grid {
        background-color: var(--dark-primary-color);
        height: 100%;
      }
      
      .section {
        display: flex;
        align-items: center;
        height: 80%;
        padding-left: 6px;
        padding-right: 6px;
      }

      .section.search {
        flex: 1;
      }

      .section.search paper-input {
        flex:1;
      }

      .section.parameters {
        max-width: 368px;
      }

      .section .title {
        font-size: 14px;
        font-weight: lighter;
        height: 100%;
        color: var(--secondary-text-color);
      }

      .section .values {
        display:flex;
        flex-wrap: wrap;
        align-items: center;
        height: 100%;
      }

      .border-left {
        border-left: 1px solid var(--divider-color);
      }
    </style>

    <app-toolbar>
      <div class="section">
        <paper-dropdown-menu label="Data source">
          <paper-listbox slot="dropdown-content" selected="0">
            <paper-item>Remote PACS Server</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>
        <paper-button class="settings" on-tap="openPacsSettingsDialog"><iron-icon icon="icons:settings"></iron-icon>Settings</paper-button>
      </div>
      <!-- <paper-icon-button icon="icons:settings" title="settings" ></paper-icon-button> -->
      <!-- <div class="section parameters border-left">
        <div class="title"> Search parameters
        </div>
        <div class ="values">
          <paper-button active="{{byPatientId}}" toggles>Patient ID</paper-button>
          <paper-button active="{{byPatientName}}" toggles>Patient Name</paper-button>
          <paper-button active="{{byStudyDesc}}" toggles>Study Desc.</paper-button>
          <paper-button active="{{bySeriesDesc}}"  toggles>Series Desc.</paper-button>
        </div>
      </div> -->
      <div class="section border-left">
        <paper-dropdown-menu label="Search by">
            <paper-listbox slot="dropdown-content" selected="0">
              <paper-item>Patient ID</paper-item>
              <paper-item>Patient Name</paper-item>
              <paper-item>Study Desc.</paper-item>
              <paper-item>Series Desc.</paper-item>
            </paper-listbox>
          </paper-dropdown-menu>
      </div>
      <div class="search section border-left">
        <paper-input label="Search input" value="{{searchInput}}">
          <paper-icon-button hidden$=[[noValue(searchInput)]] on-tap="clearSearchInput" slot="suffix" icon="clear" alt="clear" title="clear">
          </paper-icon-button>
        </paper-input>
        <paper-button class="search" on-tap="search"><iron-icon icon="icons:search"></iron-icon>Search data</paper-button>
      </div>
    </app-toolbar>

    <div class="container">
      <div class="left-panel">
        ADVANCED RESULTS FILTERING
        <paper-button on-tap="addData">Add data</paper-button>
      </div>
      <div class="main-panel">
          <div class="query-results">
            <div class="search overlay">
            </div>
            <div class="error overlay">
            </div>
            <vaadin-grid
            id="grid"
            aria-label="Basic Binding Example"
            multi-sort="true"
            items="[[data]]"
            selected-items="{{selection}}">
      
            <vaadin-grid-selection-column id="selectionColumn" auto-select>
            </vaadin-grid-selection-column>
      
            <vaadin-grid-column>
              <template class="header">
                <vaadin-grid-sorter path="PatientName.value">
                  <vaadin-grid-filter aria-label="Patient Name" path="PatientName.value" value="[[_filterPatientName]]">
                    <paper-input slot="filter" label="Patient Name" value="{{_filterPatientName::input}}"></paper-input>
                  </vaadin-grid-filter>
                </vaadin-grid-sorter>
              </template>
              <template>[[item.PatientName.value]]</template>
            </vaadin-grid-column>
      
            <vaadin-grid-column>
              <template class="header">
                <vaadin-grid-sorter path="PatientID.value">
                  <vaadin-grid-filter aria-label="Patient ID" path="PatientID.value" value="[[_filterPatientID]]">
                    <paper-input slot="filter" label="Patient ID" value="{{_filterPatientID::input}}"></paper-input>
                  </vaadin-grid-filter>
                </vaadin-grid-sorter>
              </template>
              <template>[[item.PatientID.value]]</template>
            </vaadin-grid-column>
      
            <vaadin-grid-column>
              <template class="header">
                <vaadin-grid-sorter path="StudyDescription.value">
                  <vaadin-grid-filter aria-label="Study Description" path="StudyDescription.value" value="[[_filterStudyDescription]]">
                    <paper-input slot="filter" label="Study Description" value="{{_filterStudyDescription::input}}"></paper-input>
                  </vaadin-grid-filter>
                </vaadin-grid-sorter>
              </template>
              <template>[[item.StudyDescription.value]]</template>
            </vaadin-grid-column>
      
            <vaadin-grid-column>
              <template class="header">
                <vaadin-grid-sorter path="SeriesDescription.value">
                  <vaadin-grid-filter aria-label="Series Description" path="SeriesDescription.value" value="[[_filterSeriesDescription]]">
                    <paper-input slot="filter" label="Series Description" value="{{_filterSeriesDescription::input}}"></paper-input>
                  </vaadin-grid-filter>
                </vaadin-grid-sorter>
              </template>
              <template>[[item.SeriesDescription.value]]</template>
            </vaadin-grid-column>
      
            <vaadin-grid-column>
              <template class="header">
                <vaadin-grid-sorter path="ModalitiesInStudy.value">
                  <vaadin-grid-filter aria-label="Modalities in Study" path="ModalitiesInStudy.value" value="[[_filterModalitiesInStudy]]">
                    <paper-input slot="filter" label="Modalities in Study" value="{{_filterModalitiesInStudy::input}}"></paper-input>
                  </vaadin-grid-filter>
                </vaadin-grid-sorter>
              </template>
              <template>[[item.ModalitiesInStudy.value]]</template>
            </vaadin-grid-column>
      
          </vaadin-grid>
          </div>
          <div id="selectionCheckout" hidden="[[isSelectionEmpty]]" class="query-selection">
            AUTO SHOW SELECTION
          </div>
      </div>
    </div>

  </template>

  <script>
    class GexLibrary extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() {
        return 'gex-library';
      }

      static get properties() {
        return {
          aet: {
            type: String,
          },
          aec: {
            type: String,
          },
          aetListener: {
            type: String,
          },
          serverIp: {
            type: String,
          },
          serverPort: {
            type: String,
          },
          searchInput: {
            type: String,
            value: '',
          },
          byPatientId: {
            type: Boolean,
            value: true,
          },
          byPatientName: {
            type: Boolean,
            value: false,
          },
          byStudyDesc: {
            type: Boolean,
            value: false,
          },
          bySeriesDesc: {
            type: Boolean,
            value: false,
          },
          data: {
            type: Array,
            value: [],
          },
          selection: {
            type: Array,
            value: [],
            notify: true,
          },
          isSelectionEmpty: {
            type: Boolean,
            value: true,
          },
        };
      }

      static get observers() {
        return [
            '_selectionChanged(selection.splices)',
          ];
      }

      openPacsSettingsDialog() {
        const openPacsSettingsDialogEvent =
          new CustomEvent('open-pacs-settings-dialog', {});
        this.dispatchEvent(openPacsSettingsDialogEvent);
      }

      noValue(value) {
        return value === '';
      }

      clearSearchInput() {
        this.searchInput = '';
      }

      search() {
        console.log('search data!');
        // pacs query feed for now
        // searching = true;
        // handle error (i.e. pacs ip not correct)
      }

      isSelectionEmpty(selection) {
        console.log(selection);
        return selection.length === 0;
      }


      _selectionChanged() {
        this.isSelectionEmpty = (this.selection.length <= 0);
      }

      addData() {
        const data = {
          PatientName: {
            value: 'Nicolas',
          },
          PatientID: {
            value: Date.now(),
          },
          SeriesDescription: {
            value: '270387',
          },
          StudyDescription: {
            value: '270387',
          },
          ModalitiesInStudy: {
            value: 'MR',
          },
        };

        this.push('data', data);
      }
    }

    window.customElements.define(GexLibrary.is, GexLibrary);
  </script>
</dom-module>
