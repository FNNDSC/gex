<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../bower_components/polymer/lib/mixins/gesture-event-listeners.html">

<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../bower_components/chips-api/chips-api.html">

<link rel="import" href="elements/ami-viewer-2d.html">
<link rel="import" href="elements/control-panel.html">
<link rel="import" href="elements/series-preview.html">

<link rel="import" href="import-ami.html">

<link rel="import" href="../../bower_components/chips-api/chips-api.html">
<link rel="import" href="../../bower_components/chips-api/behaviors/chips-plugin-behavior.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="my-icons.html">

<dom-module id="gex-home">
  <template>
    <style include="shared-styles">
      :host {
        display: flex;
        flex: 1;
        background-color: var(--default-primary-color);
        color: var(--text-primary-color);
        font-weight: lighter;
      }

      .content {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: var(--dark-primary-color);
        overflow: hidden;
      }

      .panel {
        width: 192px;
        display: flex;
        flex-direction: column;
      }

      .viewersC {
        flex: 1;
        display:flex;
        flex-direction: row;
        /*height: 100%;
        width: 100%;*/
      }

      .viewers {
        flex: 1;
        /*display:flex;*/
        width: 0;
      }

      .viewers > div {
        flex:1;
      }

      .series{
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
      }

      .label {
        flex: 0;
        padding: 2px;
        /*min-width: 0;*/
        font-size: 12px;
        color: var(--secondary-text-color);
      }

      .ge {
        max-height: 192px;
      }

      [hidden] {
        display: none;
      }
    </style>

    <chips-api
      id="API"></chips-api>

    <div hidden$="[[!visibleBCH]]" class="panel bch">
      <app-toolbar>
        <div main-title>PACS</div>
        <paper-icon-button icon="my-icons:search" on-tap="handleBCH"></paper-icon-button>
        <paper-icon-button icon="my-icons:close" on-tap="hideBCH"></paper-icon-button>
      </app-toolbar>
      <div class="series">

        <!-- Empty-->
        <template is="dom-if" if="[[_isEmpty(dataStatus)]]">
          No data loaded.
        </template>

        <!-- Running plugin -->
        <template is="dom-if" if="[[_isRunning(dataStatus)]]">
          Running plugin.
        </template>

        <!-- Fetching data -->
        <template is="dom-if" if="[[_isFetching(dataStatus)]]">
          Fetching files.
        </template>

        <!-- Fetching ready -->
        <template is="dom-if" if="[[_isReady(dataStatus)]]">
          <template is="dom-repeat" items="[[data]]">
            <series-preview series="[[item]]" on-tap="_handleSeriesSelected"><series-preview>
          </template>
        </template>

      </div>
      <div class="ge" hidden$="[[!_isSelected(dataSelected)]]">
        <app-toolbar>
          <div main-title>GE Reference [[dataGStatus]]</div>
        </app-toolbar>
        <div class="series">
          <template is="dom-repeat" items="[[dataG]]">
            <series-preview series="[[item]]" on-tap="_handleGESeriesSelected"><series-preview>
          </template>
        </div>
      </div>
      <div class="label">
        Copyright (c) 2016 The FNNDSC Project Authors. All rights reserved.</iron-icon>
      </div>
    </div>
    <div hidden$="[[visibleBCH]]" class="bch">
      <paper-icon-button icon="my-icons:chevron-right" on-tap="showBCH"></paper-icon-button>
    </div>

    <div class="content">
      <div class="viewersC">
        <ami-viewer-2d
          id="render"
          class="viewers"
          stack-scene="[[stackSceneBch]]"
          stack-index="{{stackIndex}}"
          stack-max-index="[[stackMaxIndex]]"
          orientation="{{orientation}}"
          stack-orientation="{{stackOrientationIndex}}"
          stack-window-width="[[stackWindowWidth]]"
          stack-window-center="[[stackWindowCenter]]"></ami-viewer-2d>
        <ami-viewer-2d
          hidden$="[[!_isSelected(dataGSelected)]]"
          id="render2"
          class="viewers"
          stack-scene="[[stackSceneGe]]"
          stack-index="{{stackIndexGE}}"
          stack-max-index="[[stackMaxIndexGE]]"
          orientation="{{orientationGE}}"
          stack-orientation="{{stackOrientationIndexGE}}"
          stack-window-width="[[stackWindowWidthGE]]"
          stack-window-center="[[stackWindowCenterGE]]"></ami-viewer-2d>
      </div>

    </div>

    <div hidden$="[[!visibleGE]]" class="panel">
      <app-toolbar>
        <div main-title>Control PACS</div>
        <paper-icon-button icon="my-icons:close" on-tap="hideGE"></paper-icon-button>
      </app-toolbar>
      <control-panel
        stack-helper="{{stackHelperBch}}"
        stack-index="{{stackIndex}}"
        stack-max-index="{{stackMaxIndex}}"
        orientation="{{orientation}}"
        stack-orientation="{{stackOrientationIndex}}"
        stack-window-width="{{stackWindowWidth}}"
        stack-window-center="{{stackWindowCenter}}"
      ></control-panel>
    </div>
    <div hidden$="[[!_isSelected(dataGSelected)]]" class="panel">
      <app-toolbar>
        <div main-title>Control GE</div>
        <paper-icon-button icon="my-icons:close" on-tap="hideGE"></paper-icon-button>
      </app-toolbar>
      <control-panel
        stack-helper="{{stackHelperGe}}"
        stack-index="{{stackIndexGE}}"
        stack-max-index="{{stackMaxIndexGE}}"
        orientation="{{orientationGE}}"
        stack-orientation="{{stackOrientationIndexGE}}"
        stack-window-width="{{stackWindowWidthGE}}"
        stack-window-center="{{stackWindowCenterGE}}"
      ></control-panel>
    </div>
    <div hidden$="[[visibleGE]]" class="ge">
      <paper-icon-button icon="my-icons:chevron-left" on-tap="showGE"></paper-icon-button>
    </div>
  </template>

  <script>
    class GEXHome extends CHIPSPluginBehavior(Polymer.GestureEventListeners(Polymer.Element)) {
      static get is() { return 'gex-home'; }

      static get properties() {
        return {
          data: {
            type: Array,
            value: [],
          },
          dataStatus: {
            type: String,
            value: '',
            observer: '_dataStatusChanged',
          },
          dataSelected: {
            type: Object,
            value: {},
            observer: '_dataSelectedChanged',
          },
          dataG: {
            type: Array,
            value: [],
          },
          dataGStatus: {
            type: String,
            value: '',
          },
          dataGSelected: {
            type: Object,
            value: {},
            observer: '_dataGSelectedChanged',
          },
          running: {
            type: Boolean,
            value: false,
          },
          visibleGE: {
            type: Boolean,
            value: true,
            observer: '_visibleGEChanged',
          },
          visibleBCH: {
            type: Boolean,
            value: true,
            observer: '_visibleBCHChanged',
          },
          stackHelperBch: {
            type: Object,
            value: {},
          },
          stackSceneBch: {
            type: Object,
            value: {},
          },
          stackHelperGe: {
            type: Object,
            value: {},
          },
          stackSceneGe: {
            type: Object,
            value: {},
          },
          geLink: {
            type: String,
            value: '',
          },
          previousInstance: {
            type: Object,
            value: {},
          },
        };
      }

      constructor() {
        super();
        this._resizeListenerBound = this._resizeListener.bind(this);
      }

      connectedCallback() {
        super.connectedCallback();
        window.addEventListener('resize', this._resizeListenerBound);
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        window.removeEventListener('resize', this._resizeListenerBound);
      }

      handleBCH(event) {
        event.stopPropagation();
        event.preventDefault();
        const openDialog = new CustomEvent(
          'open-dialog',
          {
            detail: {
              open: true,
            },
            bubbles: true,
            composed: true,
          }
        );
        this.dispatchEvent(openDialog);
      }

      handleGE(event) {
        const data = {};
        data.auth = {
          type: 'token',
          token: sessionStorage.getItem('token'),
        };
        //
        data.body = {};
        data.body.template = {};
        // the prefix:
        data.body.template.data = [
          {name: 'prefix', value: ''},
          {name: 'sleep', value: ''},
          {name: 'previous_id', value: ''},
        ];
        data.body.data = {};
        data.body.data['prefix'] = 'ge';
        data.body.data['sleep'] = '10';
        data.body.data['previous_id'] = this.previousInstance.data.id;

        this.$.API.handleAs = 'json';
        const start = this.__startPlugin(this.$.API, this.geLink, data);
        start.then(this._handleRetrieveResponse.bind(this))
          .catch(this._handleRetrieveError.bind(this));
      }

      _handleRetrieveResponse(response) {
        const fetchData = new CustomEvent(
          'start-ge',
          {
            detail: {
              feedLink: this.feedLink,
              pluginInstance: response.data[0],
          },
        });

        // booo :(
        // backend hangs if we do not wait a bit....
        window.setTimeout(
          () => {
            this.dispatchEvent(fetchData);
          }, 1000);
      }

      _handleRetrieveError(error) {
        console.log(error);
      }

      hideBCH() {
        this.visibleBCH = false;
      }

      hideGE() {
        this.visibleGE = false;
      }

      showBCH() {
        this.visibleBCH = true;
      }

      showGE() {
        this.visibleGE = true;
      }

      _handleSeriesSelected(event) {
        const targetSeries = event.model.__data.item;
        this._handleSelected(targetSeries, 'dataSelected', 'data');
      }

      _handleGESeriesSelected(event) {
        const targetSeries = event.model.__data.item;
        this._handleSelected(targetSeries, 'dataGSelected', 'dataG');
      }

      _handleSelected(targetSeries, selection, data) {
        if (this[selection].selected !== undefined) {
          this.set([data, ...this[selection].path, 'selected'], false);
        }
        // select current
        this.set(selection, targetSeries);
        this.set([data, ...targetSeries.path, 'selected'], true);
      }

      _dataSelectedChanged(dataSelected) {
        if (dataSelected === undefined || !dataSelected.data) {
          return;
        }

        const urls = dataSelected.data.map(function(obj) {
          return `${obj.links.file_resource}`;
        });

        this._urlsSelectedChanged(urls, 'Bch');
      }

      _dataGSelectedChanged(dataGSelected) {
        if (dataGSelected === undefined || !dataGSelected.data) {
          return;
        }

        const urls = dataGSelected.data.map(function(obj) {
          return `${obj.links.file_resource}`;
        });

        this._urlsSelectedChanged(urls, 'Ge');
      }

      _handleSelectedChanged(selection, targetLabel) {
        if (selection === undefined || !selection.data) {
          return;
        }
        const urlsSelected = selection.data.map(function(obj) {
          return `${obj.links.file_resource}`;
        });
        this.set(targetLabel, urlsSelected);
      }

      _fetchUrl(url) {
        const dataAPI = {};
        dataAPI.auth = {
          type: 'token',
          token: sessionStorage.getItem('token')
        };
        this.$.API.handleAs = 'arraybuffer';
        return this.$.API.request( 'GET', url, dataAPI );
      }

      _loadUrl(url) {
        const LoadersVolume = AMI.default.Loaders.Volume;
        const loader = new LoadersVolume();

        return this._fetchUrl(url)
          .then((arrayBuffer) => {
            return loader.parse({
              url: url,
              buffer: arrayBuffer,
              });
          })
          .catch(function(error) {
            window.console.log('oops... something went wrong...');
            window.console.log(error);
          });
      }

      _loadUrls(urls) {
        const loadSequences = [];
        urls.forEach((url) => {
          loadSequences.push(
            this._loadUrl(url)
          );
        });
        return Promise.all(loadSequences);
      }

      _urlsSelectedChanged(urls, target) {
        if(urls === undefined ||
          urls.length <= 0) {
          return;
        }

        // cleanup GE data
        if (target === 'Bch') {
          this.set('dataG', []);
          this.set('dataGSelected', {});
          this.set('dataGStatus', 'empty');
        }

        let stackHelper = this[`stackHelper${target}`];
        let stackScene = this[`stackScene${target}`];

        return this._loadUrls(urls)
          .then((series) => {
            // merge series
            const mergedSeries = series[0].mergeSeries(series);
            const firstSeries = mergedSeries[0];
            return firstSeries;
          })
          .then((series) => {
            // cleanup
            if (stackHelper !== null &&
              stackHelper._stack) {
              // reset renderers
              stackScene.remove(stackHelper);
              this.set(`stackScene${target}`, null);
              stackHelper.dispose();
              this.set(`stackHelper${target}`, null);
            }

            // new stack Helper
            const localHelper = new AMI.default.Helpers.Stack(series.stack[0]);
            this.set(`stackHelper${target}`, localHelper);

            const localScene = new THREE.Scene();
            localScene.add(localHelper);
            this.set(`stackScene${target}`, localScene);

            this.$.render.resize();
            this.$.render2.resize();

            // update extra info
            this.$.render.patientID = series.patientID;
            this.$.render.patientAge = series.patientAge;
            this.$.render.patientBorthdate = series.patientBorthdate;
            this.$.render.studyDescription = series.studyDescription;
            this.$.render.seriesDescription = series.seriesDescription;

            // start rendering loop
            this.$.render.startRenderingLoop();
            this.$.render2.startRenderingLoop();

            // auto fetch GE data
            if (target === 'Bch') {
              this.handleGE();
            }
          })
          .catch((error) => {
            console.log(error);
          });
      }

      _dataStatusChanged(status) {
        if (status !== 'ready') {
          this.set('data', []);
          this.set('dataSelected', {});
          this.set('dataG', []);
          this.set('dataGSelected', {});

          // stop rendering loops
          this.$.render.stopRenderingLoop();
          this.$.render2.stopRenderingLoop();
        } 
      }

      _visibleGEChanged(visible) {
        this.$.render.resize();
        this.$.render2.resize();
      }

      _visibleBCHChanged(visible) {
        this.$.render.resize();
        this.$.render2.resize();
      }

      _resizeListener() {
        this.$.render.resize();
        this.$.render2.resize();
      }

      _isEmpty(status) {
        return status === 'empty';
      }

      _isRunning(status) {
        return status === 'running';
      }

      _isFetching(status) {
        return status === 'fetching';
      }

      _isReady(status) {
        return status === 'ready';
      }

      _isSelected(data) {
        return !(data === undefined || !data.data)
      }
    }

    window.customElements.define(GEXHome.is, GEXHome);
  </script>
</dom-module>
