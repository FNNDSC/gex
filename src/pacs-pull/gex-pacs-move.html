<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-selection-column.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-filter.html">

<link rel="import" href="../../bower_components/chips-api/chips-api.html">
<link rel="import" href="../../bower_components/chips-api/behaviors/chips-plugin-behavior.html">

<dom-module id="gex-pacs-move">
  <template>
    <style>
      :host {
        display: flex;
        width: 100%;
        /*24+24+64+20+56+24*/
        height: calc(100vh - 212px);
      }

      .container {
        display: block;
        flex-direction: column;
        width: 840px;
        margin-left: auto;
        margin-right: auto;
        height: calc(100vh - 212px);
      }

      .action {
        display: flex;
        justify-content: space-around;
        padding: 12px;
      }

      paper-button {
        background: var(--accent-color);
        color: white;
      }

      /*vaadin-grid-cell-content {
        background: var(--default-primary-color);
      }*/

      vaadin-grid {
        background-color: var(--dark-primary-color);
        --vaadin-grid-header-cell: {
          background-color: var(--default-primary-color);
        };
        --vaadin-grid-body-cell: {
          background-color: var(--dark-primary-color);
        };
        --vaadin-grid-body-row-hover-cell: {
          background-color: var(--light-primary-color);
          font-weight: bold;
          cursor: pointer;
        };
        --vaadin-grid-body-row-selected-cell: {
          background-color: var(--light-primary-color);
        };
      }

    </style>

  <chips-api
    id="API"
    on-response="_blockEvent"
    on-error="_blockEvent"></chips-api>

  <div class="container">

    <vaadin-grid
      id="grid"
      aria-label="Basic Binding Example"
      multi-sort="true"
      items="[[data]]"
      selected-items="{{selection}}"
      style="height: calc(100% - 40px);">

      <vaadin-grid-selection-column id="selectionColumn" auto-select>
      </vaadin-grid-selection-column>

      <vaadin-grid-column>
        <template class="header">
          <vaadin-grid-sorter path="PatientName.value">
            <vaadin-grid-filter aria-label="Patient Name" path="PatientName.value" value="[[_filterPatientName]]">
              <paper-input slot="filter" label="Patient Name" value="{{_filterPatientName::input}}"></paper-input>
            </vaadin-grid-filter>
          </vaadin-grid-sorter>
        </template>
        <template>[[item.PatientName.value]]</template>
      </vaadin-grid-column>

      <vaadin-grid-column>
        <template class="header">
          <vaadin-grid-sorter path="PatientID.value">
            <vaadin-grid-filter aria-label="Patient ID" path="PatientID.value" value="[[_filterPatientID]]">
              <paper-input slot="filter" label="Patient ID" value="{{_filterPatientID::input}}"></paper-input>
            </vaadin-grid-filter>
          </vaadin-grid-sorter>
        </template>
        <template>[[item.PatientID.value]]</template>
      </vaadin-grid-column>

      <vaadin-grid-column>
        <template class="header">
          <vaadin-grid-sorter path="StudyDescription.value">
            <vaadin-grid-filter aria-label="Study Description" path="StudyDescription.value" value="[[_filterStudyDescription]]">
              <paper-input slot="filter" label="Study Description" value="{{_filterStudyDescription::input}}"></paper-input>
            </vaadin-grid-filter>
          </vaadin-grid-sorter>
        </template>
        <template>[[item.StudyDescription.value]]</template>
      </vaadin-grid-column>

      <vaadin-grid-column>
        <template class="header">
          <vaadin-grid-sorter path="SeriesDescription.value">
            <vaadin-grid-filter aria-label="Series Description" path="SeriesDescription.value" value="[[_filterSeriesDescription]]">
              <paper-input slot="filter" label="Series Description" value="{{_filterSeriesDescription::input}}"></paper-input>
            </vaadin-grid-filter>
          </vaadin-grid-sorter>
        </template>
        <template>[[item.SeriesDescription.value]]</template>
      </vaadin-grid-column>

      <vaadin-grid-column>
        <template class="header">
          <vaadin-grid-sorter path="ModalitiesInStudy.value">
            <vaadin-grid-filter aria-label="Modalities in Study" path="ModalitiesInStudy.value" value="[[_filterModalitiesInStudy]]">
              <paper-input slot="filter" label="Modalities in Study" value="{{_filterModalitiesInStudy::input}}"></paper-input>
            </vaadin-grid-filter>
          </vaadin-grid-sorter>
        </template>
        <template>[[item.ModalitiesInStudy.value]]</template>
      </vaadin-grid-column>

    </vaadin-grid>

  </div>

  </template>

  <script>
    class GEXPacsMove extends CHIPSPluginBehavior(Polymer.Element) {
      static get is() {
        return 'gex-pacs-move';
      }

      static get properties() {
        return {
          data: {
            type: Array,
            value: [],
            observer: '_dataChanged',
          },
          selection: {
            type: Array,
            value: [],
            notify: true,
          },
          settings: {
            type: Object,
            value: {},
          },
          previousInstance: {
            type: Number,
            value: -1,
          },
          pluginInstance: {
            type: Object,
            value: {},
            notify: true,
          },
          target: {
            type: String,
            value: '',
          },
        };
      }

      _dataChanged(data) {
        // Polymer 2.0 will call with `undefined` on initialization.
        // Ignore until we are properly called with a string.
        if (data === undefined) {
          return;
        }
      }

      _newQuery() {
        this.reset();
        var pageEvent = new CustomEvent(
          'page', {detail: {
              page: 'query',
            },
          }
        );
        this.dispatchEvent(pageEvent);
      }

      next() {
        const data = {};
        data.auth = {
          type: 'token',
          token: sessionStorage.getItem('token'),
        };
        //
        data.body = {};
        data.body.template = {};
        data.body.template.data = [
          {name: 'aet', value: ''},
          {name: 'aec', value: ''},
          {name: 'server_ip', value: ''},
          {name: 'server_port', value: ''},
          {name: 'previous_id', value: ''},
        ];
        data.body.data = this.settings;
        data.body.data['previous_id'] = this.previousInstance;

        const uids = [];
        for (var j=0; j<this.selection.length; j++) {
          uids.push(this.selection[j]['uid'].value);
        }
        if (uids.length > 0) {
          data.body.template.data.push(
            {name: 'series_uids', value: ''});
          data.body.data['series_uids'] = uids.join(',');
        }

        const start = this.__startPlugin(this.$.API, this.target, data);
        start.then(this._handleRetrieveResponse.bind(this))
          .catch(this._handleRetrieveError.bind(this));
      }

      _handleRetrieveResponse(response) {
        this.set('pluginInstance', response.data[0]);
        const closeEvent = new CustomEvent(
          'response', {detail: {
              data: {
                status: 'close',
              },
            },
          }
        );

        // booo :(
        // backend hangs if we do not wait a bit....
        window.setTimeout(
          () => {
            this.dispatchEvent(closeEvent);
          }, 1000);
      }

      _handleRetrieveError(error) {
        const moveResponseEvent = new CustomEvent(
          'response', {detail: {
              data: error,
            },
          }
        );
        this.dispatchEvent(moveResponseEvent);
      }

      _blockEvent(event) {
        event.stopPropagation();
      }

      reset() {
        // this.selection = [] does not reset the seleciton Column.
        this.$.selectionColumn.selectAll = true;
        this.$.selectionColumn.selectAll = false;
      }

    }

    window.customElements.define(GEXPacsMove.is, GEXPacsMove);
  </script>
</dom-module>