<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../bower_components/polymer/lib/mixins/gesture-event-listeners.html">

<!-- App components  -->
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">

<!-- Paper components  -->
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">

<!--Chips components  -->
<link rel="import" href="../bower_components/chips-api/chips-api.html">
<link rel="import" href="../bower_components/chips-api/behaviors/chips-plugin-behavior.html">

<!-- Local components  -->
<link rel="import" href="elements/ami-viewer-2d.html">
<link rel="import" href="elements/ami-viewer.html">
<link rel="import" href="elements/gex-panel.html">
<link rel="import" href="elements/gex-layout-manager.html">
<link rel="import" href="elements/series-preview.html">
<link rel="import" href="elements/image-controls.html">
<link rel="import" href="elements/viewer-global-controls.html">

<link rel="import" href="import-ami.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="layout-icons.html">
<link rel="import" href="gex-icons.html">

<dom-module id="gex-viewer">
  <template>
    <style include="shared-styles">
      :host {
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-flex: 1;
            -ms-flex: 1;
                flex: 1;
        background-color: var(--dark-primary-color);
        color: var(--text-primary-color);
        font-weight: lighter;
        width: 100%;
      }

      .content {
        -webkit-box-flex: 1;
            -ms-flex: 1;
                flex: 1;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-orient: vertical;
        -webkit-box-direction: normal;
            -ms-flex-direction: column;
                flex-direction: column;
        background-color: var(--dark-primary-color);
        overflow: hidden;
        position: relative;
      }

      .overlay {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: var(--dark-primary-color);
        z-index: 2;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-orient: vertical;
        -webkit-box-direction: normal;
            -ms-flex-direction: column;
                flex-direction: column;
        -webkit-box-pack: center;
            -ms-flex-pack: center;
                justify-content: center;
        -webkit-box-align: center;
            -ms-flex-align: center;
                align-items: center;
        font-size: 24px;
      }

      .panel {
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-orient: vertical;
        -webkit-box-direction: normal;
            -ms-flex-direction: column;
                flex-direction: column;
      }

      .viewersContainer {
        -webkit-box-flex: 1;
            -ms-flex: 1;
                flex: 1;
        display:-webkit-box;
        display:-ms-flexbox;
        display:flex;
        -webkit-box-orient: horizontal;
        -webkit-box-direction: normal;
            -ms-flex-direction: row;
                flex-direction: row;
      }

      .viewers {
        -webkit-box-flex: 1;
            -ms-flex: 1;
                flex: 1;
        height: 0;
        width: 100%;
      }

      .viewerui {
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        height: 100%;
        position: relative;
        -webkit-box-orient: vertical;
        -webkit-box-direction: normal;
            -ms-flex-direction: column;
                flex-direction: column;
        width: 0;
        -webkit-box-flex: 1;
            -ms-flex: 1;
                flex: 1;
        -webkit-box-sizing: border-box;
                box-sizing: border-box;
        border: 1px solid #212121;
        border-bottom: 4px solid #212121;
      }

      .viewerui.active {
        border-bottom-color: var(--accent-color);
      }

      .series{
        -webkit-box-flex: 1;
            -ms-flex: 1;
                flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
      }

      .label {
        -webkit-box-flex: 0;
            -ms-flex: 0;
                flex: 0;
        padding: 2px;
        /*min-width: 0;*/
        font-size: 12px;
        color: var(--secondary-text-color);
      }

      .border-bottom {
        border-bottom: 1px solid var(--divider-color);
      }

      .border-right {
        border-right: 1px solid var(--divider-color);
      }

      .border-left {
        border-left: 1px solid var(--divider-color);
      }

      .loader {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: var(--dark-primary-color);
        z-index: 2;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-align: center;
            -ms-flex-align: center;
                align-items: center;
        -webkit-box-pack: center;
            -ms-flex-pack: center;
                justify-content: center;
        color: #ffffff;
        -webkit-box-orient: vertical;
        -webkit-box-direction: normal;
            -ms-flex-direction: column;
                flex-direction: column;
      }

      .globalControls {
        width: 100%;
        background-color: var(--dark-primary-color);
      }

      .illustration {
        width: 128px;
        height: 128px;
        margin: auto;
        margin-bottom: 24px;
      }

      .search-image {
        background-image: url("/images/search.svg");
        background-position: center;
        background-size: contain;
        background-repeat: no-repeat;
      }

      .left-image {
        background-image: url("/images/people.svg");
        background-position: center;
        background-size: contain;
        background-repeat: no-repeat;
      }

      .overlay paper-button {
        display: block;
      }

      .retrieving {
        padding: 10px;
      }

      series-preview {
        margin: 4px;
      }

      [hidden] {
        display: none;
      }
    </style>

    <chips-api
      id="API"></chips-api>

    <template is="dom-if" if="[[_isReady(dataStatusBch)]]">
      <gex-panel
        class="border-right"
        on-is-open-changed="_panelIsOpenChanged">
          <div slot="title">Series</div>
          <div slot="content">
            <div class="series">
                <!-- Fetching ready -->
                <template is="dom-if" if="[[_isReady(dataStatusBch)]]">
                  <template is="dom-repeat" items="[[dataBch]]">
                    <series-preview
                      active="[[active]]"
                      layout="[[currentLayout]]"
                      draggable="true"
                      on-dragstart="_onDragStart"
                      series="[[item]]"><series-preview>
                  </template>
                </template>

              </div>
              <div class="ge" hidden$="[[!_isSelected(dataSelectedBch)]]">
                <app-toolbar>
                  <div main-title>Reference</div>
                </app-toolbar>
                <div class="series">
                  <template is="dom-repeat" items="[[dataGe]]">
                    <series-preview
                      active="[[active]]"
                      layout="[[currentLayout]]"
                      draggable="true"
                      on-dragstart="_onDragStart"
                      series="[[item]]"
                      on-tap="_handleSeriesSelectedGe"><series-preview>
                  </template>
                </div>
              </div>
              <div class="label">
                Copyright (c) 2017 FNNDSC, BCH. All rights reserved.</iron-icon>
              </div>
          </div>
      </gex-panel>
    </template>

    <div class="content">
      <!-- global controls -->
      <div class="globalControls border-bottom">
        <viewer-global-controls layout="{{layout}}" theater-mode="{{theaterMode}}"></viewer-global-controls>
      </div>

      <!-- viewers container -->
      <div class="viewersContainer">
        <gex-layout-manager
          active="[[active]]"
          layout="[[layout]]"
          fullscreen="[[fullscreen]]"
          on-iron-resize="_layoutSizeChanged">
            <ami-viewer
              id="viewer0"
              data-uid="0"
              slot="s0"
              color-lut="{{colorLut0}}"
              cursor="{{cursor}}"
              histogram="{{histogram0}}"
              min-max="{{minMax0}}"
              orientation="{{orientation0}}"
              window-center="{{windowCenter0}}"
              window-level="{{windowLevel0}}"
              window-width="{{windowWidth0}}"
              on-enter-fullscreen="_onEnterFullscreen"
              on-exit-fullscreen="_onExitFullscreen"
              on-activate="_onActivateRenderer"
              on-deactivate="_onDeactivateRenderer"
              on-drop="_onDrop"
              on-dragenter="_onDragEnter"
              on-dragleave="_onDragLeave"
              on-dragover="_onDragOver"></ami-viewer>

            <ami-viewer
              id="viewer1"
              data-uid="1"
              slot="s1"
              color-lut="{{colorLut1}}"
              cursor="{{cursor}}"
              histogram="{{histogram1}}"
              min-max="{{minMax1}}"
              orientation="{{orientation1}}"
              window-center="{{windowCenter1}}"
              window-level="{{windowLevel1}}"
              window-width="{{windowWidth1}}"
              on-enter-fullscreen="_onEnterFullscreen"
              on-exit-fullscreen="_onExitFullscreen"
              on-activate="_onActivateRenderer"
              on-deactivate="_onDeactivateRenderer"
              on-drop="_onDrop"
              on-dragenter="_onDragEnter"
              on-dragleave="_onDragLeave"
              on-dragover="_onDragOver"></ami-viewer>

            <ami-viewer
              id="viewer2"
              data-uid="2"
              slot="s2"
              color-lut="{{colorLut2}}"
              cursor="{{cursor}}"
              histogram="{{histogram2}}"
              min-max="{{minMax2}}"
              orientation="{{orientation2}}"
              window-center="{{windowCenter2}}"
              window-level="{{windowLevel2}}"
              window-width="{{windowWidth2}}"
              on-enter-fullscreen="_onEnterFullscreen"
              on-exit-fullscreen="_onExitFullscreen"
              on-activate="_onActivateRenderer"
              on-deactivate="_onDeactivateRenderer"
              on-drop="_onDrop"
              on-dragenter="_onDragEnter"
              on-dragleave="_onDragLeave"
              on-dragover="_onDragOver"></ami-viewer>

            <ami-viewer
              id="viewer3"
              data-uid="3"
              slot="s3"
              color-lut="{{colorLut3}}"
              cursor="{{cursor}}"
              histogram="{{histogram3}}"
              min-max="{{minMax3}}"
              orientation="{{orientation3}}"
              window-center="{{windowCenter3}}"
              window-level="{{windowLevel3}}"
              window-width="{{windowWidth3}}"
              on-enter-fullscreen="_onEnterFullscreen"
              on-exit-fullscreen="_onExitFullscreen"
              on-activate="_onActivateRenderer"
              on-deactivate="_onDeactivateRenderer"
              on-drop="_onDrop"
              on-dragenter="_onDragEnter"
              on-dragleave="_onDragLeave"
              on-dragover="_onDragOver"></ami-viewer>

        </gex-layout-manager>
      </div>
      </div>
    </div>

    <template is="dom-if" if="[[_isReady(dataStatusBch)]]">
      <gex-panel
        class="border-left"
        size="large"
        on-is-open-changed="_panelIsOpenChanged">

        <div slot="title">Selection</div>
        <div slot="content">
          <image-controls
            hidden$="[[_hideControls(0, active)]]"
            activate="[[_hideControls(0, active)]]"
            color-lut="{{colorLut0}}"
            histogram="[[histogram0]]"
            min-max="[[minMax0]]"
            orientation="{{orientation0}}"
            window-center="{{windowCenter0}}"
            window-level="{{windowLevel0}}"
            window-width="{{windowWidth0}}"></image-controls>

          <image-controls
            hidden$="[[_hideControls(1, active)]]"
            activate="[[_hideControls(1, active)]]"
            color-lut="{{colorLut1}}"
            histogram="[[histogram1]]"
            min-max="[[minMax1]]"
            orientation="{{orientation1}}"
            window-center="{{windowCenter1}}"
            window-level="{{windowLevel1}}"
            window-width="{{windowWidth1}}"></image-controls>

          <image-controls
            hidden$="[[_hideControls(2, active)]]"
            activate="[[_hideControls(2, active)]]"
            color-lut="{{colorLut2}}"
            histogram="[[histogram2]]"
            min-max="[[minMax2]]"
            orientation="{{orientation2}}"
            window-center="{{windowCenter2}}"
            window-level="{{windowLevel2}}"
            window-width="{{windowWidth2}}"></image-controls>

          <image-controls
            hidden$="[[_hideControls(3, active)]]"
            activate="[[_hideControls(3, active)]]"
            color-lut="{{colorLut3}}"
            histogram="[[histogram3]]"
            min-max="[[minMax3]]"
            orientation="{{orientation3}}"
            window-center="{{windowCenter3}}"
            window-level="{{windowLevel3}}"
            window-width="{{windowWidth3}}"></image-controls>
          </div>
      </div>
      <div hidden$="[[visibleInfo]]" class="ge">
        <paper-icon-button icon="gex-icons:chevron-left" on-tap="showInfo"></paper-icon-button>
      </div>
    </template>
  </template>

  <script>
    class GEXViewer extends CHIPSPluginBehavior(
      Polymer.GestureEventListeners(Polymer.Element)) {
      static get is() {
        return 'gex-viewer';
      }

      static get properties() {
        return {
          dataBch: {
            type: Array,
            value: [
              {
                details: {
                  series: {
                    uid: 1,
                    description: 'Sag FLAIR CUBE',
                    date: '2011-05-20',
                    files: '159',
                    preview: {
                      blob: null,
                      url: '../images/demo/sag.jpg',
                    },
                  },
                },
              },
              {
                details: {
                  series: {
                    uid: 0,
                    description: 'Borjan SAG T2',
                    date: '2013-05-27',
                    files: '176',
                    preview: {
                      blob: null,
                      url: '../images/demo/sag.jpg',
                    },
                  },
                },
              },
              {
                details: {
                  series: {
                    uid: 2,
                    description: 'SAG 3D IR',
                    date: '2012-12-03',
                    files: '90',
                    preview: {
                      blob: null,
                      url: '../images/demo/sag.jpg',
                    },
                  },
                },
              },
            ],
          },
          dataStatusBch: {
            type: String,
            value: '',
            observer: '_dataStatusBchChanged',
          },
          activeBch: {
            type: Boolean,
            value: true,
            observer: '_activeBchChanged',
          },
          dataGe: {
            type: Array,
            value: [],
          },
          dataStatusGe: {
            type: String,
            value: '',
          },
          activeGe: {
            type: Boolean,
            value: false,
            observer: '_activeGeChanged',
          },
          running: {
            type: Boolean,
            value: false,
          },
          geLink: {
            type: String,
            value: '',
          },
          previousInstance: {
            type: Object,
            value: {},
          },
          layout: {
            type: Number,
            value: 0,
            observer: '_layoutSizeChanged',
          },
          currentLayout: {
            type: Array,
            value: [],
          },
          active: {
            type: Number,
            value: -1,
          },
          fullscreen: {
            type: Number,
            value: -1,
          },
          fullscreenViewer: {
            type: Boolean,
            value: false,
          },
          theaterMode: {
            type: Boolean,
            observer: '_theaterModeChanged',
          },
        };
      }

      constructor() {
        super();
        this._resizeListenerBound = this._resizeListener.bind(this);
        this._fullscreenListenerBound = this._fullscreenListener.bind(this);
      }

      connectedCallback() {
        super.connectedCallback();
        window.addEventListener('resize', this._resizeListenerBound);
        this.addEventListener(
          'webkitfullscreenchange', this._fullscreenListenerBound);
        this.addEventListener(
          'mozfullscreenchange', this._fullscreenListenerBound);
        this.addEventListener(
          'fullscreenchange', this._fullscreenListenerBound);
        this.addEventListener(
          'MSfullscreenchange', this._fullscreenListenerBound);
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        window.removeEventListener('resize', this._resizeListenerBound);
        this.removeEventListener(
          'webkitfullscreenchange', this._fullscreenListenerBound);
        this.removeEventListener(
          'mozfullscreenchange', this._fullscreenListenerBound);
        this.removeEventListener(
          'fullscreenchange', this._fullscreenListenerBound);
        this.addremoveEventListenerEventListener(
          'MSfullscreenchange', this._fullscreenListenerBound);
      }

      handleGE(event) {
        const data = {};
        data.auth = {
          type: 'token',
          token: sessionStorage.getItem('token'),
        };
        //
        const settings = {
          aet: 'CHIPS',
          aec: 'ORTHANC',
          server_ip: '192.168.1.40',
          server_port: '4242',
        };

        data.body = {};
        data.body.template = {};
        data.body.template.data = [
          {name: 'aet', value: ''},
          {name: 'aec', value: ''},
          {name: 'server_ip', value: ''},
          {name: 'server_port', value: ''},
          {name: 'series_file', value: ''},
          {name: 'series_uids', value: ''},
          {name: 'previous_id', value: ''},
        ];

        data.body.data = settings;
        data.body.data['previous_id'] = this.previousInstance.data.id;
        data.body.data['series_file'] = '/ge-demo/normative-moco.txt';
        data.body.data['series_uids'] = '0';

        this.$.API.handleAs = 'json';
        const start = this.__startPlugin(this.$.API, this.geLink, data);
        start.then(this._handleRetrieveResponse.bind(this))
          .catch(this._handleRetrieveError.bind(this));
      }

      _handleRetrieveResponse(response) {
        const fetchData = new CustomEvent(
          'start-ge',
          {
            detail: {
              feedLink: this.feedLink,
              pluginInstance: response.data[0],
          },
        });

        // booo :(
        // backend hangs if we do not wait a bit....
        window.setTimeout(
          () => {
            this.dispatchEvent(fetchData);
          }, 1000);
      }

      _handleRetrieveError(error) {
        console.log(error);
      }

      _dataStatusBchChanged(status) {
        if (status !== 'ready') {
          this.set('dataBch', []);
          this.set('dataSelectedBch', {});
          this.set('dataGe', []);
          this.set('dataSelectedGe', {});
        }
      }

      _panelIsOpenChanged() {
        this._layoutSizeChanged();
        return;
      }

      _isEmpty(status) {
        console.log(status);
        return status === 'empty';
      }

      _isRunning(status) {
        return status === 'running';
      }

      _isFetching(status) {
        return status === 'fetching';
      }

      _isReady(status) {
        if(sessionStorage.getItem('username') === 'demo') {
          this.dataStatusBch = 'ready';
          return true;
        }

        return status === 'ready';
      }

      _isSelected(data) {
        return !(data === undefined || !data.data);
      }

      _isReadyAndNotSelected(status, data) {
        if(sessionStorage.getItem('username') === 'demo') {
          return false;
        }

        const ready = this._isReady(status);
        const selected = this._isSelected(data);
        return ready && !selected;
      }

      _activeBchChanged(active) {
        if (active) {
          this.activeGe = false;
        }
      }

      _activeGeChanged(active) {
        if (active) {
          this.activeBch = false;
        }
      }

      _isLoading(target, dataSelectedBch, dataSelectedGe, urlsTotal) {
        // number of files reset to 0 when urls are loaded
        if (target === 'bch' && dataSelectedBch && dataSelectedBch.data &&
          (dataSelectedGe === undefined || dataSelectedGe.data ==undefined) &&
          urlsTotal > 0) {
          return true;
        } else if (
          target === 'ge' &&
          dataSelectedGe &&
          dataSelectedGe.data &&
          urlsTotal > 0) {
          return true;
        }

        return false;
      }

      /**
       * Start dragging a series preview
       *
       * @param {*} event
       */
      _onDragStart(event) {
        // event.stopEvent();
        // console.log("dragStart");
        this.draggingSeries = event.model.__data.item.details.series.uid;

        // event.dataTransfer.dropEffect = 'copy';
        // event.dataTransfer.setData("text/plain", event.target.id);
        // event.dataTransfer.effectAllowed = "asd";
        // event.dataTransfer.setData("text/plain", "OK");
        // event.dataTransfer.setData('foo', 'HI THERE');
      }

      /**
       * Drop a series preview
       *
       * @param {*} event
       */
      _onDrop(event) {
        event.preventDefault();
        console.log(event.dataTransfer.getData("text"));
        //
        event.target.drag = false;
        // alway load same data for now
        const t1 = [
          '36747136', '36747150', '36747164', '36747178',
          '36747192', '36747206', '36747220', '36747234', '36747248', '36747262',
          '36747276', '36747290', '36747304', '36747318', '36747332', '36747346',
          '36747360', '36747374', '36747388', '36747402', '36747416', '36747430',
          '36747444', '36747458', '36747472', '36747486', '36747500', '36747514',
          '36747528', '36747542', '36747556', '36747570', '36747584', '36747598',
          '36747612', '36747626', '36747640', '36747654', '36747668', '36747682',
          '36747696', '36747710', '36747724', '36747738', '36747752', '36747766',
          '36747780', '36747794', '36747808', '36747822', '36747836', '36747850',
          '36747864', '36747878', '36747892', '36747906', '36747920', '36747934',
          '36747948', '36747962', '36747976', '36747990', '36748004', '36748018',
          '36748032', '36748046', '36748060', '36748074', '36748088', '36748102',
          '36748116', '36748130', '36748144', '36748158', '36748172', '36748186',
          '36748578', '36748592',
          '36748606', '36748620', '36748634', '36748648', '36748662', '36748676',
          '36748690', '36748704', '36748718', '36748732', '36748746', '36748760',
          '36748774', '36748788', '36748802', '36748816', '36748830', '36748844',
          '36748858', '36748872', '36748886', '36748900', '36748914', '36748928',
          '36748942', '36748956', '36748970', '36748984', '36748998', '36749012',
          '36749026', '36749040', '36749054', '36749068', '36749082', '36749096',
          '36749110', '36749124', '36749138', '36749152', '36749166', '36749180',
          '36749194', '36749208', '36749222', '36749236', '36749250', '36749264',
          '36749278', '36749292', '36749306', '36749320', '36749334', '36749348',
          '36749362', '36749376', '36749390', '36749404', '36749418',
          '36749446', '36749460', '36749474', '36749488', '36749502', '36749516',
          '36749530', '36749544', '36749558', '36749572', '36749586', '36749600',
          '36749614', '36749628', '36749642', '36749656', '36749670', '36749684',
          '36749698', '36749712', '36749726', '36749740', '36749754', '36749768',
          '36749782', '36749796', '36749810', '36749824', '36749838', '36749852',
          '36749866', '36749880', '36749894', '36749908', '36749922', '36749936',
          '36749950', '36749964',
        ];

        const images = t1.map(function(v) {
          return 'https://cdn.rawgit.com/FNNDSC/data/master/dicom/adi_brain/' + v;
        });

        // const targetViewerUID = event.target.dataset.uid;
        const targetViewer = event.target;
        this.set(['currentLayout', targetViewer.dataset.uid], this.draggingSeries);
        console.log(this.currentLayout);


        targetViewer.images = images;
      }

      _onDragEnter(event) {
        event.preventDefault();
        console.log(event);
        console.log(event.target.dataset.uid);
        event.target.drag = true;
      }

      _onDragOver(event) {
        event.preventDefault();
        console.log(event.target.dataset.uid);
      }

      _onDragLeave(event) {
        event.preventDefault();
        event.target.drag = false;
        console.log(event.target.dataset.uid);
      }

      _onEnterFullscreen(event) {
        console.log(event.target.dataset.uid);
        this.fullscreen = event.target.dataset.uid;
        this.active = this.fullscreen;
        this._layoutSizeChanged();
      }

      _onExitFullscreen() {
        this.fullscreen = -1;
        this._layoutSizeChanged();
      }

      _onActivateRenderer(event) {
        this.active = event.target.dataset.uid;
      }

      _onDeactivateRenderer(event) {
        this.active = -1;
      }

      _theaterModeChanged() {
        let currentlyFullscreen = false;
        if (document.fullscreenElement ||
          document.webkitFullscreenElement ||
          document.mozFullScreenElement ||
          document.msFullscreenElement) {
          currentlyFullscreen = true;
        }

        // go fulll screen!
        if(this.theaterMode && !currentlyFullscreen) {
          // request fullscreen
          // https://developer.mozilla.org/en-US/docs/Web/API/Fullscreen_API
          this.webkitRequestFullScreen();
        } else if (!this.theaterMode && currentlyFullscreen) {
          if (document.exitFullscreen)
            document.exitFullscreen();
          else if (document.webkitExitFullscreen)
            document.webkitExitFullscreen();
          else if (document.mozCancelFullScreen)
            document.mozCancelFullScreen();
          else if (document.msExitFullscreen)
            document.msExitFullscreen();
        }
      }

      _fullscreenListener(event) {
        // if user exit fullscreen with the "esc" key
        // we notify the toolbar
        if (!(document.fullscreenElement ||
          document.webkitFullscreenElement ||
          document.mozFullScreenElement ||
          document.msFullscreenElement) && this.theaterMode) {
          this.theaterMode = false;
        }

        this._layoutSizeChanged();
      }

      _hideControls(current, target) {
        if (Number(current) === 0 && Number(target) === -1) {
          return false;
        }

        return (Number(current) !== Number(target));
      }

      _resizeListener() {
        this._layoutSizeChanged();
      }

      _layoutSizeChanged(layout) {
        if (layout === undefined) {
          return;
        }

        console.log(layout);

        if (Number.isInteger(layout)) {
          console.log(layout);
          // add/remove entries in the current layout
          let emptyLayout = [-1, -1, -1, -1];
          let newLayout = [...this.currentLayout, ...emptyLayout];
          this.currentLayout = newLayout.slice(0, layout + 1);
        } else {
          console.log('ok');
        }

        // resize viewers
        this.$.viewer0.resize();
        this.$.viewer1.resize();
        this.$.viewer2.resize();
        this.$.viewer3.resize();
      }
    }

    window.customElements.define(GEXViewer.is, GEXViewer);
  </script>
</dom-module>
